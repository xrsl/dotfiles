#!/usr/bin/env bash
set -euo pipefail

# Linux CLI tools installer
# Usage: install-tools [tool...]
# If no args, installs all tools

INSTALL_DIR="${HOME}/.local/bin"
mkdir -p "$INSTALL_DIR"

ensure_path() {
    local path_line='export PATH="$HOME/.local/bin:$HOME/.local/share/fnm:$PATH"'
    local fnm_line='eval "$(fnm env)"'

    for rc in "$HOME/.bashrc" "$HOME/.zshrc"; do
        [[ -f "$rc" ]] || continue
        if ! grep -qF '.local/bin' "$rc"; then
            echo "$path_line" >> "$rc"
            echo "Added PATH to $rc"
        fi
        # Add fnm env if fnm is installed
        if [[ -d "$HOME/.local/share/fnm" ]] && ! grep -qF 'fnm env' "$rc"; then
            echo "$fnm_line" >> "$rc"
            echo "Added fnm env to $rc"
        fi
    done
}

install_cue() {
    echo "Installing cue..."
    local version=$(curl -sL "https://api.github.com/repos/cue-lang/cue/releases/latest" | grep '"tag_name"' | cut -d'"' -f4)
    curl -sL "https://github.com/cue-lang/cue/releases/download/${version}/cue_${version}_linux_amd64.tar.gz" | tar -xz -C "$INSTALL_DIR" cue
}

install_just() {
    echo "Installing just..."
    rm -f "$INSTALL_DIR/just"
    curl --proto '=https' --tlsv1.2 -sSf https://just.systems/install.sh | bash -s -- --to "$INSTALL_DIR"
}

install_starship() {
    echo "Installing starship..."
    curl -sS https://starship.rs/install.sh | sh -s -- -b "$INSTALL_DIR" -y
}

install_yq() {
    echo "Installing yq..."
    local version=$(curl -sL "https://api.github.com/repos/mikefarah/yq/releases/latest" | grep '"tag_name"' | cut -d'"' -f4)
    curl -sL "https://github.com/mikefarah/yq/releases/download/${version}/yq_linux_amd64" -o "$INSTALL_DIR/yq"
    chmod +x "$INSTALL_DIR/yq"
}

install_gh() {
    echo "Installing gh..."
    local version=$(curl -sL "https://api.github.com/repos/cli/cli/releases/latest" | grep '"tag_name"' | cut -d'"' -f4 | sed 's/v//')
    curl -sL "https://github.com/cli/cli/releases/download/v${version}/gh_${version}_linux_amd64.tar.gz" | tar -xz --strip-components=2 -C "$INSTALL_DIR" "gh_${version}_linux_amd64/bin/gh"
}

install_watchexec() {
    echo "Installing watchexec..."
    local version=$(curl -sL "https://api.github.com/repos/watchexec/watchexec/releases/latest" | grep '"tag_name"' | cut -d'"' -f4)
    local tmp_dir=$(mktemp -d)
    curl -sL "https://github.com/watchexec/watchexec/releases/download/${version}/watchexec-${version}-x86_64-unknown-linux-musl.tar.xz" -o "$tmp_dir/watchexec.tar.xz"
    if command -v xz &>/dev/null; then
        tar -xJf "$tmp_dir/watchexec.tar.xz" -C "$tmp_dir"
    else
        python3 -c "import lzma,sys;sys.stdout.buffer.write(lzma.open('$tmp_dir/watchexec.tar.xz').read())" | tar -xf - -C "$tmp_dir"
    fi
    mv "$tmp_dir/watchexec-${version}-x86_64-unknown-linux-musl/watchexec" "$INSTALL_DIR/"
    rm -rf "$tmp_dir"
}

install_jq() {
    echo "Installing jq..."
    local version=$(curl -sL "https://api.github.com/repos/jqlang/jq/releases/latest" | grep '"tag_name"' | cut -d'"' -f4)
    curl -sL "https://github.com/jqlang/jq/releases/download/${version}/jq-linux-amd64" -o "$INSTALL_DIR/jq"
    chmod +x "$INSTALL_DIR/jq"
}

install_tombi() {
    echo "Installing tombi..."
    local version=$(curl -sL "https://api.github.com/repos/tombi-toml/tombi/releases/latest" | grep '"tag_name"' | cut -d'"' -f4)
    curl -sL "https://github.com/tombi-toml/tombi/releases/download/${version}/tombi-cli-${version#v}-x86_64-unknown-linux-musl.gz" | gunzip > "$INSTALL_DIR/tombi"
    chmod +x "$INSTALL_DIR/tombi"
}

install_typos() {
    echo "Installing typos..."
    local version=$(curl -sL "https://api.github.com/repos/crate-ci/typos/releases/latest" | grep '"tag_name"' | cut -d'"' -f4)
    curl -sL "https://github.com/crate-ci/typos/releases/download/${version}/typos-${version}-x86_64-unknown-linux-musl.tar.gz" | tar -xz -C "$INSTALL_DIR" ./typos
}

install_typst() {
    echo "Installing typst..."
    local version=$(curl -sL "https://api.github.com/repos/typst/typst/releases/latest" | grep '"tag_name"' | cut -d'"' -f4)
    local tmp_dir=$(mktemp -d)
    curl -sL "https://github.com/typst/typst/releases/download/${version}/typst-x86_64-unknown-linux-musl.tar.xz" -o "$tmp_dir/typst.tar.xz"
    # Use python lzma if xz not available
    if command -v xz &>/dev/null; then
        tar -xJf "$tmp_dir/typst.tar.xz" -C "$tmp_dir"
    else
        python3 -c "import lzma,sys;sys.stdout.buffer.write(lzma.open('$tmp_dir/typst.tar.xz').read())" | tar -xf - -C "$tmp_dir"
    fi
    mv "$tmp_dir/typst-x86_64-unknown-linux-musl/typst" "$INSTALL_DIR/"
    rm -rf "$tmp_dir"
}

install_fnm() {
    echo "Installing fnm (Node version manager)..."
    curl -fsSL https://fnm.vercel.app/install | bash -s -- --skip-shell --install-dir "$HOME/.local/share/fnm"
    export PATH="$HOME/.local/share/fnm:$PATH"
    eval "$($HOME/.local/share/fnm/fnm env)"
    fnm install --lts
    fnm default lts-latest
}

install_kiro() {
    echo "Installing kiro-cli..."
    curl -fsSL https://cli.kiro.dev/install | bash
    # Verify installation
    if [[ -x "$INSTALL_DIR/kiro" ]]; then
        echo "kiro installed successfully to $INSTALL_DIR/kiro"
    else
        echo "Warning: kiro binary not found at $INSTALL_DIR/kiro"
    fi
}

install_npm_tools() {
    echo "Installing npm tools (cspell, gemini, kilocode, copilot)..."
    export PATH="$HOME/.local/share/fnm:$PATH"
    eval "$($HOME/.local/share/fnm/fnm env)" 2>/dev/null || { echo "fnm not found. Run: install-tools fnm"; return 1; }
    npm install -g cspell @google/gemini-cli @kilocode/cli @github/copilot
}

# Aliases for convenience
install_gemini() { install_npm_tools; }
install_kilocode() { install_npm_tools; }
install_copilot() { install_npm_tools; }
install_cspell() { install_npm_tools; }

ALL_TOOLS="cue just starship yq gh watchexec typos typst jq tombi fnm kiro npm_tools"

if [[ $# -eq 0 ]]; then
    tools="$ALL_TOOLS"
else
    tools="$*"
fi

for tool in $tools; do
    if declare -f "install_$tool" > /dev/null; then
        install_$tool
    else
        echo "Unknown tool: $tool"
    fi
done

ensure_path
echo "Done. Restart your shell or run: source ~/.bashrc (or ~/.zshrc)"
