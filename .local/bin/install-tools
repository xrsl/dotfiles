#!/usr/bin/env bash
set -euo pipefail

# Linux CLI tools installer
# Usage: install-tools [tool...]
# If no args, installs all tools

INSTALL_DIR="${HOME}/.local/bin"
mkdir -p "$INSTALL_DIR"

install_cue() {
    echo "Installing cue..."
    local version=$(curl -sL "https://api.github.com/repos/cue-lang/cue/releases/latest" | grep '"tag_name"' | cut -d'"' -f4)
    curl -sL "https://github.com/cue-lang/cue/releases/download/${version}/cue_${version}_linux_amd64.tar.gz" | tar -xz -C "$INSTALL_DIR" cue
}

install_just() {
    echo "Installing just..."
    curl --proto '=https' --tlsv1.2 -sSf https://just.systems/install.sh | bash -s -- --to "$INSTALL_DIR"
}

install_starship() {
    echo "Installing starship..."
    curl -sS https://starship.rs/install.sh | sh -s -- -b "$INSTALL_DIR" -y
}

install_yq() {
    echo "Installing yq..."
    local version=$(curl -sL "https://api.github.com/repos/mikefarah/yq/releases/latest" | grep '"tag_name"' | cut -d'"' -f4)
    curl -sL "https://github.com/mikefarah/yq/releases/download/${version}/yq_linux_amd64" -o "$INSTALL_DIR/yq"
    chmod +x "$INSTALL_DIR/yq"
}

install_gh() {
    echo "Installing gh..."
    local version=$(curl -sL "https://api.github.com/repos/cli/cli/releases/latest" | grep '"tag_name"' | cut -d'"' -f4 | sed 's/v//')
    curl -sL "https://github.com/cli/cli/releases/download/v${version}/gh_${version}_linux_amd64.tar.gz" | tar -xz --strip-components=2 -C "$INSTALL_DIR" "gh_${version}_linux_amd64/bin/gh"
}

install_watchexec() {
    echo "Installing watchexec..."
    local version=$(curl -sL "https://api.github.com/repos/watchexec/watchexec/releases/latest" | grep '"tag_name"' | cut -d'"' -f4)
    curl -sL "https://github.com/watchexec/watchexec/releases/download/${version}/watchexec-${version}-x86_64-unknown-linux-musl.tar.xz" -o /tmp/watchexec.tar.xz
    tar -xJf /tmp/watchexec.tar.xz -C /tmp
    mv "/tmp/watchexec-${version}-x86_64-unknown-linux-musl/watchexec" "$INSTALL_DIR/"
    rm -rf /tmp/watchexec.tar.xz /tmp/watchexec-*
}

install_jq() {
    echo "Installing jq..."
    local version=$(curl -sL "https://api.github.com/repos/jqlang/jq/releases/latest" | grep '"tag_name"' | cut -d'"' -f4)
    curl -sL "https://github.com/jqlang/jq/releases/download/${version}/jq-linux-amd64" -o "$INSTALL_DIR/jq"
    chmod +x "$INSTALL_DIR/jq"
}

install_tombi() {
    echo "Installing tombi..."
    local version=$(curl -sL "https://api.github.com/repos/tombi-toml/tombi/releases/latest" | grep '"tag_name"' | cut -d'"' -f4)
    curl -sL "https://github.com/tombi-toml/tombi/releases/download/${version}/tombi-cli-${version#v}-x86_64-unknown-linux-musl.gz" | gunzip > "$INSTALL_DIR/tombi"
    chmod +x "$INSTALL_DIR/tombi"
}

install_typos() {
    echo "Installing typos..."
    local version=$(curl -sL "https://api.github.com/repos/crate-ci/typos/releases/latest" | grep '"tag_name"' | cut -d'"' -f4)
    curl -sL "https://github.com/crate-ci/typos/releases/download/${version}/typos-${version}-x86_64-unknown-linux-musl.tar.gz" | tar -xz -C "$INSTALL_DIR" ./typos
}

install_typst() {
    echo "Installing typst..."
    local version=$(curl -sL "https://api.github.com/repos/typst/typst/releases/latest" | grep '"tag_name"' | cut -d'"' -f4)
    curl -sL "https://github.com/typst/typst/releases/download/${version}/typst-x86_64-unknown-linux-musl.tar.xz" -o /tmp/typst.tar.xz
    tar -xJf /tmp/typst.tar.xz -C /tmp
    mv /tmp/typst-x86_64-unknown-linux-musl/typst "$INSTALL_DIR/"
    rm -rf /tmp/typst.tar.xz /tmp/typst-x86_64-unknown-linux-musl
}

ALL_TOOLS="cue just starship yq gh watchexec typos typst jq tombi"

if [[ $# -eq 0 ]]; then
    tools="$ALL_TOOLS"
else
    tools="$*"
fi

for tool in $tools; do
    if declare -f "install_$tool" > /dev/null; then
        install_$tool
    else
        echo "Unknown tool: $tool"
    fi
done

echo "Done. Ensure $INSTALL_DIR is in your PATH."
